services:
  seed:
    build:
      context: .
      dockerfile: Dockerfile
      target: seed
    environment:
      - DATABASE_PATH=/data/yak.sqlite
      - TEST_EMAIL=${TEST_EMAIL}
      - TEST_PASSWORD=${TEST_PASSWORD}
    volumes:
      - yakdata:/data
    networks:
      - chat-net
    profiles:
      - tools

  migrate:
    build:
      context: .
      dockerfile: Dockerfile
      target: migrate-db
    environment:
      - DATABASE_PATH=/data/yak.sqlite
    volumes:
      - yakdata:/data
    networks:
      - chat-net
    command: ["sh", "-c", "pnpm exec tsx lib/db/migrate.ts && chown -R 1001:1001 /data"]
    restart: "no"

  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    container_name: yak
    restart: unless-stopped
    mem_limit: 512m
    cpus: 1.0
    security_opt:
      - no-new-privileges:true
    depends_on:
      migrate:
        condition: service_completed_successfully
      garage:
        condition: service_started
      cliproxy:
        condition: service_started
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.yak.rule=Host(`chat.funnydomainname.com`)"
      - "traefik.http.routers.yak.entrypoints=web"
      - "traefik.http.services.yak.loadbalancer.server.port=3000"
      - "traefik.http.routers.yak.middlewares=secure-headers,rate-limit"
    environment:
      - HOSTNAME=0.0.0.0
      - CLIPROXY_BASE_URL=http://cliproxy:8317/v1
      - AI_PROXY_KEY=${AI_PROXY_KEY}
      - AUTH_SECRET=${AUTH_SECRET}
      - DATABASE_PATH=/data/yak.sqlite
      - AUTH_TRUST_HOST=true
      - AUTH_URL=https://chat.funnydomainname.com
      - GROQ_API_KEY=${GROQ_API_KEY}
      - S3_ENDPOINT=http://garage:3900
      - S3_REGION=garage
      - S3_BUCKET=${S3_BUCKET:-yak-files}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - JOB_TOKEN=${JOB_TOKEN}
    volumes:
      - yakdata:/data
      - hfcache:/app/.cache/huggingface
    networks:
      - chat-net
      - traefik

  garage:
    image: dxflrs/garage:v2.2.0
    container_name: yak-garage
    restart: unless-stopped
    mem_limit: 256m
    cpus: 0.5
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./garage.toml:/etc/garage.toml
      - ./data/garage/meta:/var/lib/garage/meta
      - ./data/garage/data:/var/lib/garage/data
    networks:
      - chat-net

  cliproxy:
    image: eceasy/cli-proxy-api:latest
    container_name: yak-cliproxy
    restart: unless-stopped
    mem_limit: 128m
    cpus: 0.25
    security_opt:
      - no-new-privileges:true
    volumes:
      - /opt/cli-proxy-api/config.yaml:/CLIProxyAPI/config.yaml
      - /opt/cli-proxy-api/auths:/root/.cli-proxy-api
      - /opt/cli-proxy-api/logs:/CLIProxyAPI/logs
    networks:
      - chat-net

  jobs:
    image: hectorm/supercronic:latest
    container_name: yak-jobs
    restart: unless-stopped
    mem_limit: 64m
    cpus: 0.1
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./crontab:/app/crontab:ro
    environment:
      - JOB_TOKEN=${JOB_TOKEN}
    command: ["/app/crontab"]
    depends_on:
      app:
        condition: service_started
    networks:
      - chat-net

volumes:
  yakdata:
  hfcache:

networks:
  chat-net:
    name: yak-network
  traefik:
    external: true
